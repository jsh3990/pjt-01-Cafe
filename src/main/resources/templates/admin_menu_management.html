<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Java Coffee</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/admin_menu_management.css">

    <style>
        /* ===================== Toast UI ===================== */
        #toastBox {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 9999;
        }

        .toast {
            background: rgba(40, 40, 40, 0.9);
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 14px;
            animation: fadeInOut 3s forwards;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
    </style>
</head>
<body>

<th:block
        th:replace="~{./include/adminBaseLayout :: setContent( ~{:: .wrap} ) }"
        th:with="menuList=${menuList}, menu=${menu}">

    <div class="wrap">
        <div class="admin-container">
            <main class="admin-main">

                <!-- ================= 등록된 메뉴 테이블 ================= -->
                <section class="menu-list-section">
                    <h2>등록된 메뉴</h2>
                    <div class="menu-actions">
                        <button class="select-delete-btn">선택 메뉴 삭제</button>
                    </div>

                    <div class="table-scroll-container">
                        <table class="menu-table">
                            <thead>
                            <tr>
                                <th class="text-center">선택</th>
                                <th class="text-center">메뉴 이름</th>
                                <th class="text-center">가격</th>
                                <th class="text-center">카테고리</th>
                                <th class="text-center">메뉴 삭제</th>
                            </tr>
                            </thead>

                            <tbody>
                            <th:block th:each="m : ${menuList}">
                                <tr class="menu-row" th:data-menu-id="${m.menuId}">
                                    <td><input type="checkbox" th:value="${m.menuId}"></td>
                                    <td th:text="${m.menuName}"></td>
                                    <td th:text="${m.menuPrice} + '원'"></td>
                                    <td th:text="${m.category}"></td>
                                    <td><button class="delete-btn" th:data-id="${m.menuId}">×</button></td>
                                </tr>

                                <!-- 상세 옵션 -->
                                <tr class="detail-row" style="display:none;">
                                    <td colspan="5">
                                        <div class="detail-box">
                                            <label>판매 상태 변경</label>
                                            <select class="status-select">
                                                <option value="판매중" th:selected="${m.salesStatus == '판매중'}">판매중</option>
                                                <option value="품절" th:selected="${m.salesStatus == '품절'}">품절</option>
                                            </select>

                                            <button class="status-save-btn" th:data-id="${m.menuId}">저장</button>

                                            <button class="edit-menu-btn" th:data-id="${m.menuId}">
                                                수정하기
                                            </button>

                                        </div>
                                    </td>
                                </tr>
                            </th:block>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- ================= 신규 & 수정 폼 ================= -->
                <aside class="new-menu-section">
                    <h2 th:text="${menu != null} ? '메뉴 수정' : '새 메뉴 등록'"></h2>

                    <form id="newMenuForm" class="new-menu-form"
                          th:action="${menu != null} ? @{/admin/updateMenu} : @{/admin/insertMenu}"
                          method="post"
                          enctype="multipart/form-data">

                        <input type="hidden" name="menuId"
                               th:value="${menu != null} ? ${menu.menuId} : ''">

                        <!-- ⭐ 수정 시 판매 상태 유지 -->
                        <input type="hidden" name="salesStatus"
                               th:value="${menu != null} ? ${menu.salesStatus} : '판매중'">

                        <label for="menuName">메뉴 이름</label>
                        <input type="text" id="menuName" name="menuName"
                               placeholder="예) 아메리카노"
                               th:value="${menu != null} ? ${menu.menuName} : ''" required>

                        <label for="menuPrice">가격</label>
                        <input type="text" id="menuPrice" name="menuPrice"
                               placeholder="숫자만 입력해주세요. 예) 3000"
                               th:value="${menu != null} ? ${#numbers.formatInteger(menu.menuPrice, 3, 'COMMA')} + '원' : ''"
                               required>

                        <label for="menuCategory">카테고리</label>
                        <select id="menuCategory" name="category" required>
                            <option value="" disabled selected>카테고리 선택</option>
                            <option value="커피" th:selected="${menu != null && menu.category == '커피'}">커피</option>
                            <option value="음료" th:selected="${menu != null && menu.category == '음료'}">음료</option>
                            <option value="신메뉴" th:selected="${menu != null && menu.category == '신메뉴'}">신메뉴</option>
                            <option value="티" th:selected="${menu != null && menu.category == '티'}">티(Tea)</option>
                            <option value="푸드" th:selected="${menu != null && menu.category == '푸드'}">푸드</option>
                        </select>

                        <label for="menuTemperature">HOT ICE (푸드는 ICE로 선택)</label>
                        <select id="menuTemperature" name="temperature" required>
                            <option value="" disabled selected>온도 선택</option>

                            <option value="AVAILABLE"
                                    th:selected="${menu != null && menu.hotAvailable == 1}">
                                HOT ICE
                            </option>

                            <option value="ONLY_ICE"
                                    th:selected="${menu != null && menu.hotAvailable == 0}">
                                ICE
                            </option>
                        </select>

                        <label for="menuDescription">메뉴 설명</label>
                        <textarea id="menuDescription" name="menuDefinition"
                                  th:text="${menu != null} ? ${menu.menuDefinition} : ''"></textarea>

                        <label>사진</label>
                        <div class="image-upload-box" onclick="document.getElementById('menuImage').click();">
                            <span class="material-icons" th:if="${menu == null}">add</span>

                            <img th:if="${menu != null && menu.menuImg != null}"
                                 th:src="@{'/upload/menuImg/' + ${menu.menuImg}}"
                                 style="width:100%; height:100%; object-fit:cover;">
                        </div>

                        <input type="file" id="menuImage" name="menuImgFile" style="display:none;">

                        <button type="submit" class="submit-btn"
                                th:text="${menu != null} ? '메뉴 수정' : ' 메뉴 등록'"></button>
                    </form>
                </aside>

            </main>
        </div>

        <!-- ⭐ Toast UI 영역 -->
        <div id="toastBox"></div>

        <script src="/js/admin_menu_management.js"></script>

        <!-- ================= 토스트 알림 스크립트 ================= -->
        <script th:inline="javascript">
            function showToast(msg) {
                const box = document.getElementById("toastBox");

                let toast = document.createElement("div");
                toast.classList.add("toast");
                toast.innerText = msg;

                box.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            var updated = /*[[${updateSuccess}]]*/ false;

            if (updated === true) {
                showToast("메뉴 수정이 완료되었습니다!");
            }
        </script>

    </div>
</th:block>

</body>
</html>
