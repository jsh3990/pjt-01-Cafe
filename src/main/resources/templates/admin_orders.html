<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì ì£¼ë¬¸ ëª©ë¡ (Dynamic) - Java Cafe</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin.css">
</head>

<script th:inline="javascript">
    /* Thymeleaf ë³€ìˆ˜ ì²˜ë¦¬ ìˆ˜ì • */
    let storeName = /*[[${storeName}]]*/ "";
    let eventSource = null;
    let reconnectTimer = null;
</script>

<th:block th:replace="~{./include/adminBaseLayout :: setContent( ~{:: .wrap} ) }">
    <div class="wrap">
        <main class="main-content">
            <h2 class="main-title">ì£¼ë¬¸ ëª©ë¡</h2>

            <div class="order-grid" id="order-grid-container">
            </div>
            <div id="empty-orders" class="order-grid-empty">
                í˜„ì¬ ì ‘ìˆ˜ëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </main>
    </div>
</th:block>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = '/api/orders';
        const API_ENDPOINT_LIST = `${API_BASE_URL}/admin-list?storeName=${encodeURIComponent(storeName)}`;
        const API_ENDPOINT_STATUS_UPDATE = `${API_BASE_URL}/status`;

        const orderGrid = document.getElementById('order-grid-container');
        const removedOrderIds = new Set();

        // ---------------------------
        // 1. ì´ˆê¸° ì£¼ë¬¸ ëª©ë¡ 1íšŒ ë¡œë”©
        // ---------------------------
        async function loadInitialOrders() {
            try {
                const response = await fetch(API_ENDPOINT_LIST, { cache: 'no-store' });
                if (!response.ok) throw new Error(response.status);

                const orders = await response.json();
                renderOrders(orders);

            } catch (e) {
                console.error('ì´ˆê¸° ì£¼ë¬¸ ë¡œë”© ì‹¤íŒ¨:', e);
                if(orderGrid.children.length === 0) {
                    orderGrid.innerHTML = `<div class="order-grid-empty">ì£¼ë¬¸ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨ (${e.message})</div>`;
                }
            }
        }

        // ---------------------------
        // 2. ì£¼ë¬¸ ë Œë”ë§ í•¨ìˆ˜
        // ---------------------------
        function renderOrders(orders) {
            orderGrid.innerHTML = '';
            orders.forEach(order => {
                if(removedOrderIds.has(String(order.orderId))) return;

                orderGrid.insertAdjacentHTML('beforeend', createOrderCard(order));
                const card = document.getElementById(`order-card-${order.orderId}`);
                if (card) {
                    setTimeout(() => { card.classList.add('show'); }, 10);
                }
            });
            updateEmptyState();
        }

        function updateEmptyState() {
            const emptyBox = document.getElementById('empty-orders');
            if (!orderGrid || !emptyBox) return;
            const hasCards = orderGrid.querySelectorAll('.order-card:not(.hide)').length > 0;
            emptyBox.style.display = hasCards ? "none" : "block";
        }

        // ---------------------------
        // 3. SSE ì—°ê²°
        // ---------------------------
        function connectSSE(targetStoreName) {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }

            const encoded = encodeURIComponent(targetStoreName);
            const sseUrl = `/sse/admin/${encoded}`;

            console.log(`ğŸ”Œ SSE ì—°ê²° ì‹œë„: ${sseUrl}`);
            eventSource = new EventSource(sseUrl);

            eventSource.onopen = function(e) {
                console.log("ğŸŸ¢ ì„œë²„ì™€ SSE ì—°ê²° ì„±ê³µ! ë°ì´í„° ë™ê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.");
                loadInitialOrders();
            };

            eventSource.addEventListener("new-order", (event) => {
                const order = JSON.parse(event.data);
                const idStr = String(order.orderId);

                if (removedOrderIds.has(idStr) || document.getElementById(`order-card-${order.orderId}`)) {
                    return;
                }

                insertCardToTop(createOrderCard(order), order.orderId);
                updateEmptyState();
                showAdminToast("ìƒˆë¡œìš´ ì£¼ë¬¸ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!");
            });

            eventSource.addEventListener("order-update", (event) => {
                console.log("ìƒíƒœ ë³€ê²½ ê°ì§€, ëª©ë¡ ê°±ì‹ ");
                loadInitialOrders();
            });

            eventSource.onerror = () => {
                console.error("ğŸ”´ SSE ì—°ê²° ëŠê¹€/ì˜¤ë¥˜. 3ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„...");
                if(eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
                reconnectTimer = setTimeout(() => connectSSE(targetStoreName), 3000);
            };
        }

        // ---------------------------
        // 4. ì£¼ë¬¸ ì¹´ë“œ ìƒì„± (HTML)
        // ---------------------------
        function createOrderCard(order) {
            let cardTypeClass = 'type-default';
            if (order.orderType === 'ë§¤ì¥') cardTypeClass = 'type-store';
            else if (order.orderType === 'í¬ì¥') cardTypeClass = 'type-takeout';
            else if (order.orderType === 'ë°°ë‹¬') cardTypeClass = 'type-delivery';

            const menuItemsHtml = (order.orderItemList || []).map(item => {
                const tumblerTxt = item.tumbler === 1 ? "í…€ë¸”ëŸ¬" : "ì¼ë°˜ì»µ";
                const tempTxt = item.temp ? item.temp.toUpperCase() : "";
                const shotTxt = item.shot > 0 ? `ìƒ· : ${item.shot}` : "";
                const syrupTxt = item.vanillaSyrup > 0 ? `ì‹œëŸ½ : ${item.vanillaSyrup}` : "";
                const creamTxt = item.whippedCream > 0 ? `íœ˜í•‘í¬ë¦¼` : "";

                const optionsText = [tumblerTxt, tempTxt, shotTxt, syrupTxt, creamTxt]
                    .filter(v => v !== "").join("<br>");

                return `
                <li>
                    <div class="menu-item-name">
                        ${item.menuItemName}
                        <span>${item.quantity}</span>
                    </div>
                    <div class="menu-options" style="line-height: 1.4">${optionsText}</div>
                </li>`;
            }).join('');

            let formattedTime = '00:00';
            if (order.orderTime) {
                try {
                    const date = new Date(order.orderTime);
                    formattedTime = `${date.getHours()}ì‹œ ${String(date.getMinutes()).padStart(2, '0')}ë¶„`;
                } catch { formattedTime = "ì‹œê°„ ì˜¤ë¥˜"; }
            }
            const formattedDailyId = `#${String(order.dailyOrderNum).padStart(4, '0')}`;
            const nickname = order.username || "ì´ë¦„ì—†ìŒ";

            return `
            <div class="order-card ${cardTypeClass}" id="order-card-${order.orderId}">
                <div>
                    <div class="card-header">
                        <span class="order-id">${formattedDailyId}</span>
                        <span class="order-time">${formattedTime}</span>
                    </div>
                    <div class="option-info">
                        <div><strong>ì£¼ë¬¸ì:</strong> ${nickname}</div>
                    </div>
                    <ul class="menu-list">${menuItemsHtml}</ul>
                </div>
                <div>
                    <div class="request-text">
                        <strong>ìš”ì²­ì‚¬í•­:</strong> ${order.requestText ? order.requestText : 'ì—†ìŒ'}
                    </div>
                    <div class="card-footer-row">
                        <span>ì´ ìˆ˜ëŸ‰</span>
                        <span>${order.totalQuantity}</span>
                    </div>
                    <div class="card-footer-total">
                        <span>${order.orderType}</span>
                        <span>${order.totalPrice.toLocaleString('ko-KR')}ì›</span>
                    </div>
                </div>
                <button class="card-menu-button" data-order-id="${order.orderId}">â‹®</button>
                <div class="card-menu-dropdown" id="menu-dropdown-${order.orderId}">
                    <button class="complete" data-status="ì£¼ë¬¸ì™„ë£Œ">âœ” ì™„ë£Œ</button>
                    <button class="cancel" data-status="ì£¼ë¬¸ì·¨ì†Œ">âœ– ì·¨ì†Œ</button>
                </div>
            </div>`;
        }

        // ---------------------------
        // 5. ì•Œë¦¼ íŒì—…
        // ---------------------------
        function showAdminToast(message) {
            const toast = document.getElementById("admin-toast");
            const msg = document.getElementById("admin-toast-message");
            if (!toast || !msg) return;

            msg.innerText = message;
            toast.classList.remove("hide");
            toast.classList.remove("show");

            setTimeout(() => toast.classList.add("show"), 10);
            setTimeout(() => {
                toast.classList.remove("show");
                toast.classList.add("hide");
            }, 3000);
        }

        // ---------------------------
        // 6. ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ (í•¨ìˆ˜ ì •ì˜)
        // ---------------------------
        async function handleUpdateStatus(orderId, status) {
            try {
                const response = await fetch(`${API_ENDPOINT_STATUS_UPDATE}/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                // 409 ì—ëŸ¬ (ì´ë¯¸ ì²˜ë¦¬ë¨)
                if (response.status === 409) {
                    alert("ì´ë¯¸ ì²˜ë¦¬ëœ ì£¼ë¬¸ì…ë‹ˆë‹¤.");
                    removeOrderCard(orderId);
                    return;
                }

                // ê·¸ ì™¸ ì—ëŸ¬
                if (!response.ok) throw new Error(response.status);

                // âœ… [ì„±ê³µ ì‹œ ì²˜ë¦¬] ì—¬ê¸°ê°€ ë¹ ì ¸ìˆì–´ì„œ ì•ˆ ì‚¬ë¼ì¡Œë˜ ê²ƒì…ë‹ˆë‹¤!
                removedOrderIds.add(String(orderId));
                removeOrderCard(orderId); // ì¦‰ì‹œ ì‚­ì œ

            } catch (e) {
                alert(`ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨ (${e.message})`);
            }
        }

        // ---------------------------
        // 7. ì´ë²¤íŠ¸ ìœ„ì„ (ì—¬ê¸°ê°€ ì‹¤ì œ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬í•˜ëŠ” ê³³)
        // ---------------------------
        orderGrid.addEventListener('click', event => {
            const target = event.target;

            // ë©”ë‰´ ë²„íŠ¼ (...)
            if (target.classList.contains('card-menu-button')) {
                event.stopPropagation();
                const orderId = Number(target.dataset.orderId);
                const dropdown = document.getElementById(`menu-dropdown-${orderId}`);

                document.querySelectorAll('.card-menu-dropdown.show').forEach(d => {
                    if (d !== dropdown) d.classList.remove('show');
                });
                dropdown.classList.toggle('show');
            }

            // ì™„ë£Œ/ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ handleUpdateStatus í˜¸ì¶œ
            if (target.matches('.card-menu-dropdown button')) {
                event.stopPropagation();
                const dropdown = target.closest('.card-menu-dropdown');
                const orderId = Number(dropdown.previousElementSibling.dataset.orderId);
                const status = target.dataset.status;

                dropdown.classList.remove('show');

                // â­ ì—¬ê¸°ì„œ ìœ„ì—ì„œ ì •ì˜í•œ handleUpdateStatusë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                handleUpdateStatus(orderId, status);
            }
        });

        // ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ë‹«ê¸°
        document.addEventListener('click', (e) => {
            if(!e.target.closest('.card-menu-button')) {
                document.querySelectorAll('.card-menu-dropdown.show').forEach(d => d.classList.remove('show'));
            }
        });

        // ---------------------------
        // 8. ì¹´ë“œ ìƒë‹¨ ì‚½ì…
        // ---------------------------
        function insertCardToTop(html, orderId) {
            // ì¤‘ë³µ ë°©ì§€ ì‚­ì œ
            const existingCard = document.getElementById(`order-card-${orderId}`);
            if (existingCard) existingCard.remove();

            orderGrid.insertAdjacentHTML('afterbegin', html);
            const card = document.getElementById(`order-card-${orderId}`);
            if(card) setTimeout(() => card.classList.add("show"), 10);
        }

        // ---------------------------
        // 9. ì¹´ë“œ ì œê±°
        // ---------------------------
        function removeOrderCard(orderId) {
            const card = document.getElementById(`order-card-${orderId}`);
            if (!card) return;
            card.classList.add("hide");
            setTimeout(() => {
                card.remove();
                updateEmptyState();
            }, 350);
        }

        // ---------------------------
        // 10. ì´ˆê¸° ì‹¤í–‰
        // ---------------------------
        if(storeName) {
            connectSSE(storeName);
        } else {
            console.error("ë§¤ì¥ëª… ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
    });

</script>
</html>