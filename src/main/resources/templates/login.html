<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인 - Fresh & Cozy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/login.css}">
</head>

<th:block th:replace="~{./include/userBaseLayout :: setContent( ~{:: .wrap} ) }">
    <div class="wrap">
        <div class="login-bg">
            <div class="login-page-wrapper">
                <div class="login-top-section">
                    <div class="logo-img"></div>
                    <div class="slogan-title">Fresh & Cozy</div>
                    <div class="slogan-subtitle">신선한 원두와 따뜻한 공간, 오늘도 함께</div>
                </div>

                <div class="login-bottom-section">

                    <!-- 1. 초기 로그인 화면 -->
                    <div id="login-options-group" class="btn-group fade-in">
                        <a href="/oauth2/authorization/kakao" class="login-btn btn-kakao-full">
                            <img src="https://developers.kakao.com/assets/img/about/logos/kakaotalksharing/kakaotalk_sharing_btn_medium.png"
                                 alt="Kakao" class="social-icon-inside-btn">
                            카카오 로그인
                        </a>
                        <button type="button" id="show-social-login-btn" class="login-btn btn-other-login">
                            다른 방법으로 로그인
                        </button>
                    </div>

                    <!-- 2. 소셜 로그인 선택 화면 -->
                    <div id="social-login-group" class="btn-group hidden-group">
                        <a href="/oauth2/authorization/naver" class="login-btn btn-naver-full">
                            <img src="https://cdn.jsdelivr.net/npm/simple-icons@v13/icons/naver.svg"
                                 alt="Naver" class="social-icon-inside-btn" style="filter: invert(1);">
                            네이버 로그인
                        </a>
                        <a href="/oauth2/authorization/google" class="login-btn btn-google-full">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg"
                                 alt="Google" class="social-icon-inside-btn">
                            Google 로그인
                        </a>
                        <button type="button" id="email-login-btn" class="login-btn btn-normal-full">
                            일반 로그인
                        </button>
                        <button type="button" id="back-to-login-btn" class="login-btn btn-cancel">
                            취소
                        </button>
                    </div>

                    <!-- 3. 일반 로그인 입력 폼 -->
                    <div id="email-login-form" class="btn-group hidden-group">
                        <form id="login-real-form" class="signup-form-container">
                            <input type="text" name="username" placeholder="이메일" class="login-input" required>
                            <input type="password" name="password" placeholder="비밀번호" class="login-input" required>

                            <div class="remember-me-container">
                                <input type="checkbox" id="remember-me" name="remember-me">
                                <label for="remember-me">로그인 상태 유지</label>
                            </div>

                            <button type="submit" class="login-btn btn-normal-full">
                                로그인
                            </button>
                        </form>
                        <button type="button" id="back-to-login-options-btn" class="login-btn btn-cancel">
                            취소
                        </button>
                    </div>

                    <!-- 4. 회원가입 토글 버튼 -->
                    <div id="signup-initial-section" class="signup-or-login-toggle-section fade-in">
                        <div class="divider-with-text"><span class="text">또는</span></div>
                        <button type="button" id="show-signup-options-btn" class="login-btn btn-other-login signup-toggle-btn">
                            회원가입
                        </button>
                    </div>

                    <!-- 5. 회원가입 방식 선택 -->
                    <div id="social-signup-group" class="btn-group hidden-group">
                        <a href="/oauth2/authorization/kakao" class="login-btn btn-kakao-full">
                            <img src="https://developers.kakao.com/assets/img/about/logos/kakaotalksharing/kakaotalk_sharing_btn_medium.png" alt="Kakao" class="social-icon-inside-btn"> 카카오 회원가입
                        </a>
                        <a href="/oauth2/authorization/naver?mode=signup" class="login-btn btn-naver-full">
                            <img src="https://cdn.jsdelivr.net/npm/simple-icons@v13/icons/naver.svg" alt="Naver Signup" class="social-icon-inside-btn" style="filter: invert(1);"> 네이버 회원가입
                        </a>
                        <a href="/oauth2/authorization/google?mode=signup" class="login-btn btn-google-full">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google Signup" class="social-icon-inside-btn"> Google 회원가입
                        </a>
                        <button type="button" id="email-signup-btn" class="login-btn btn-normal-full">
                            일반 회원가입
                        </button>
                        <button type="button" id="back-to-main-btn" class="login-btn btn-cancel">
                            취소
                        </button>
                    </div>

                    <!-- 6. 이메일 회원가입 입력 폼 -->
                    <div id="email-signup-form" class="btn-group hidden-group">
                        <form id="signup-real-form" class="signup-form-container">
                            <div class="input-group-row">
                                <input type="email" id="signup-email" name="email" placeholder="이메일" class="login-input" required>
                                <button type="button" id="check-email-btn" class="btn-check">중복확인</button>
                            </div>
                            <div id="email-check-msg" class="validation-msg"></div>

                            <input type="text" id="signup-username" name="username" placeholder="닉네임 (이름)" class="login-input" required>
                            <input type="password" id="signup-pw" name="password" placeholder="비밀번호" class="login-input" required>
                            <input type="password" id="signup-pw-confirm" name="passwordConfirm" placeholder="비밀번호 확인" class="login-input" required>
                            <div id="pw-check-msg" class="validation-msg"></div>

                            <button type="submit" class="login-btn btn-normal-full" style="margin-top: 10px;">
                                가입하기
                            </button>
                        </form>
                        <button type="button" id="back-to-signup-options-btn" class="login-btn btn-cancel">
                            취소
                        </button>
                    </div>
                </div>
            </div>

            <!-- 실패 메시지용 토스트 컨테이너 (성공 토스트는 main에서 처리) -->
            <div id="custom-toast" class="toast-hidden">
                <div class="toast-body">
                    <i class="fa-solid fa-check-circle toast-icon"></i>
                    <span id="toast-text">메시지 내용</span>
                </div>
            </div>
        </div>

        <!-- main.js 로드 (showToast 함수 사용) -->
        <script src="/js/main.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const loginPageWrapper = document.querySelector('.login-page-wrapper');

                // 요소 선택
                const loginOptionsGroup = document.getElementById('login-options-group');
                const socialLoginGroup = document.getElementById('social-login-group');
                const emailLoginFormDiv = document.getElementById('email-login-form');
                const signupInitialSection = document.getElementById('signup-initial-section');
                const socialSignupGroup = document.getElementById('social-signup-group');
                const emailSignupFormDiv = document.getElementById('email-signup-form');

                const showSocialLoginBtn = document.getElementById('show-social-login-btn');
                const backToLoginBtn = document.getElementById('back-to-login-btn');
                const emailLoginBtn = document.getElementById('email-login-btn');
                const backToLoginOptionsBtn = document.getElementById('back-to-login-options-btn');
                const showSignupOptionsBtn = document.getElementById('show-signup-options-btn');
                const backToMainBtn = document.getElementById('back-to-main-btn');
                const emailSignupBtn = document.getElementById('email-signup-btn');
                const backToSignupOptionsBtn = document.getElementById('back-to-signup-options-btn');

                const signupForm = document.getElementById('signup-real-form');
                const checkEmailBtn = document.getElementById('check-email-btn');
                const emailInput = document.getElementById('signup-email');
                const usernameInput = document.getElementById('signup-username');
                const emailCheckMsg = document.getElementById('email-check-msg');
                const pwInput = document.getElementById('signup-pw');
                const pwConfirmInput = document.getElementById('signup-pw-confirm');
                const pwCheckMsg = document.getElementById('pw-check-msg');

                let isEmailChecked = false;

                // 화면 전환 함수
                function switchGroup(hideElement, showElement) {
                    hideElement.classList.add('fade-out');
                    setTimeout(() => {
                        hideElement.style.display = 'none';
                        hideElement.classList.remove('fade-out');
                        showElement.style.display = 'flex';
                        void showElement.offsetWidth;
                        showElement.classList.remove('hidden-group');
                        showElement.classList.add('fade-in');
                        setTimeout(() => showElement.classList.remove('fade-in'), 350);
                    }, 300);
                }

                // --- 이벤트 리스너 ---
                showSocialLoginBtn.addEventListener('click', () => {
                    loginOptionsGroup.classList.add('fade-out');
                    signupInitialSection.classList.add('fade-out');
                    setTimeout(() => {
                        loginOptionsGroup.style.display = 'none';
                        signupInitialSection.style.display = 'none';
                        loginOptionsGroup.classList.remove('fade-out');
                        signupInitialSection.classList.remove('fade-out');
                        socialLoginGroup.style.display = 'flex';
                        void socialLoginGroup.offsetWidth;
                        socialLoginGroup.classList.remove('hidden-group');
                        socialLoginGroup.classList.add('fade-in');
                        setTimeout(() => socialLoginGroup.classList.remove('fade-in'), 350);
                    }, 300);
                });

                backToLoginBtn.addEventListener('click', () => {
                    socialLoginGroup.classList.add('fade-out');
                    setTimeout(() => {
                        socialLoginGroup.style.display = 'none';
                        socialLoginGroup.classList.remove('fade-out');
                        socialLoginGroup.classList.add('hidden-group');
                        loginOptionsGroup.style.display = 'flex';
                        signupInitialSection.style.display = 'flex';
                        void loginOptionsGroup.offsetWidth;
                        loginOptionsGroup.classList.add('fade-in');
                        signupInitialSection.classList.add('fade-in');
                        setTimeout(() => {
                            loginOptionsGroup.classList.remove('fade-in');
                            signupInitialSection.classList.remove('fade-in');
                        }, 350);
                    }, 300);
                });

                emailLoginBtn.addEventListener('click', () => {
                    switchGroup(socialLoginGroup, emailLoginFormDiv);
                    loginPageWrapper.classList.add('signup-mode');
                });

                backToLoginOptionsBtn.addEventListener('click', () => {
                    switchGroup(emailLoginFormDiv, socialLoginGroup);
                    loginPageWrapper.classList.remove('signup-mode');
                });

                showSignupOptionsBtn.addEventListener('click', () => {
                    loginOptionsGroup.classList.add('fade-out');
                    signupInitialSection.classList.add('fade-out');
                    setTimeout(() => {
                        loginOptionsGroup.style.display = 'none';
                        signupInitialSection.style.display = 'none';
                        loginOptionsGroup.classList.remove('fade-out');
                        signupInitialSection.classList.remove('fade-out');
                        socialSignupGroup.style.display = 'flex';
                        void socialSignupGroup.offsetWidth;
                        socialSignupGroup.classList.remove('hidden-group');
                        socialSignupGroup.classList.add('fade-in');
                        setTimeout(() => socialSignupGroup.classList.remove('fade-in'), 350);
                    }, 300);
                    loginPageWrapper.classList.add('signup-selection-mode');
                });

                backToMainBtn.addEventListener('click', () => {
                    socialSignupGroup.classList.add('fade-out');
                    setTimeout(() => {
                        socialSignupGroup.style.display = 'none';
                        socialSignupGroup.classList.remove('fade-out');
                        socialSignupGroup.classList.add('hidden-group');
                        loginOptionsGroup.style.display = 'flex';
                        signupInitialSection.style.display = 'flex';
                        void loginOptionsGroup.offsetWidth;
                        loginOptionsGroup.classList.add('fade-in');
                        signupInitialSection.classList.add('fade-in');
                        setTimeout(() => {
                            loginOptionsGroup.classList.remove('fade-in');
                            signupInitialSection.classList.remove('fade-in');
                        }, 350);
                    }, 300);
                    loginPageWrapper.classList.remove('signup-selection-mode');
                });

                emailSignupBtn.addEventListener('click', () => {
                    switchGroup(socialSignupGroup, emailSignupFormDiv);
                    loginPageWrapper.classList.remove('signup-selection-mode');
                    loginPageWrapper.classList.add('signup-mode');
                });

                backToSignupOptionsBtn.addEventListener('click', () => {
                    switchGroup(emailSignupFormDiv, socialSignupGroup);
                    loginPageWrapper.classList.remove('signup-mode');
                    loginPageWrapper.classList.add('signup-selection-mode');

                    emailInput.value = '';
                    usernameInput.value = '';
                    pwInput.value = '';
                    pwConfirmInput.value = '';
                    emailCheckMsg.textContent = '';
                    pwCheckMsg.textContent = '';
                    isEmailChecked = false;
                });

                // ============================================================
                // [핵심] 일반 로그인 처리
                // ============================================================
                loginRealForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const formData = new FormData(loginRealForm);
                    const urlEncodedData = new URLSearchParams(formData).toString();

                    fetch('/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: urlEncodedData
                    })
                        .then(async response => {
                            const data = await response.json();
                            if (!response.ok || data.error) {
                                throw new Error(data.message || "LOGIN_FAILED");
                            }
                            return data;
                        })
                        .then(data => {
                            const username = data.username || '회원';
                            window.location.href = `/home/?loginSuccess=true&username=${encodeURIComponent(username)}`;
                        })
                        .catch(err => {
                            showToast(err.message || "아이디 또는 비밀번호가 틀렸습니다.", "error");
                        });
                });

                // 회원가입 처리
                signupForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (!isEmailChecked) {
                        if (typeof showToast === 'function') showToast("이메일 중복 확인을 해주세요.", 'error');
                        else alert("이메일 중복 확인을 해주세요.");
                        emailInput.focus(); return;
                    }
                    const pw = pwInput.value;
                    const confirmPw = pwConfirmInput.value;
                    if (pw !== confirmPw) {
                        if (typeof showToast === 'function') showToast("비밀번호가 일치하지 않습니다.", 'error');
                        else alert("비밀번호가 일치하지 않습니다.");
                        pwConfirmInput.focus(); return;
                    }

                    const formData = {
                        email: emailInput.value,
                        username: usernameInput.value,
                        password: pw,
                        passwordCheck: confirmPw
                    };

                    fetch('/api/member/signup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    })
                        .then(response => {
                            if (response.ok) return response.json();
                            return response.json().then(errData => { throw errData; });
                        })
                        .then(data => {
                            if (typeof showToast === 'function') showToast("가입이 완료되었습니다! 로그인 해주세요.");
                            setTimeout(() => window.location.reload(), 1500);
                        })
                        .catch(error => {
                            let msg = "회원가입 중 오류가 발생했습니다.";
                            if (error.field === 'email') msg = "이미 사용 중인 이메일입니다.";
                            else if (error.field === 'id') msg = "이미 사용 중인 아이디입니다.";
                            else if (error.field === 'passwordCheck') msg = "비밀번호 확인이 일치하지 않습니다.";

                            if (typeof showToast === 'function') showToast(msg, 'error');
                            else alert(msg);
                        });
                });

                // 이메일 중복확인
                checkEmailBtn.addEventListener('click', function() {
                    const email = emailInput.value.trim();
                    if (!email) {
                        if (typeof showToast === 'function') showToast("이메일을 입력해주세요.", 'error');
                        emailInput.focus(); return;
                    }
                    fetch('/api/member/check-email?email=' + encodeURIComponent(email))
                        .then(response => {
                            if (response.ok) return response.json();
                            else if (response.status === 409) throw new Error("DUPLICATE");
                            else throw new Error("ERROR");
                        })
                        .then(data => {
                            emailCheckMsg.textContent = "사용 가능한 이메일입니다.";
                            emailCheckMsg.className = "validation-msg text-success";
                            isEmailChecked = true;
                        })
                        .catch(error => {
                            isEmailChecked = false;
                            if (error.message === "DUPLICATE") {
                                emailCheckMsg.textContent = "이미 존재하는 이메일입니다.";
                                emailCheckMsg.className = "validation-msg text-danger";
                            } else {
                                emailCheckMsg.textContent = "오류가 발생했습니다.";
                                emailCheckMsg.className = "validation-msg text-danger";
                            }
                        });
                });

                emailInput.addEventListener('input', () => { isEmailChecked = false; emailCheckMsg.textContent = ""; });

                function checkPasswordMatch() {
                    const pw = pwInput.value;
                    const confirmPw = pwConfirmInput.value;
                    if (!pw || !confirmPw) { pwCheckMsg.textContent = ""; return; }
                    if (pw === confirmPw) {
                        pwCheckMsg.textContent = "비밀번호가 서로 일치합니다.";
                        pwCheckMsg.className = "validation-msg text-success";
                    } else {
                        pwCheckMsg.textContent = "비밀번호가 서로 일치하지 않습니다.";
                        pwCheckMsg.className = "validation-msg text-danger";
                    }
                }
                pwInput.addEventListener('input', checkPasswordMatch);
                pwConfirmInput.addEventListener('input', checkPasswordMatch);
            });
        </script>
    </div>
</th:block>
</html>