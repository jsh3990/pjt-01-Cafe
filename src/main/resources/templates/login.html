<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인 - Fresh & Cozy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/login.css}">
</head>

<th:block th:replace="~{./include/userBaseLayout :: setContent( ~{:: .wrap} ) }">
    <div class="wrap">

        <!-- 배경 -->
        <div class="login-bg">
            <div class="login-page-wrapper">
                <div class="login-top-section">
                    <div class="logo-img"></div>
                    <div class="slogan-title">Fresh & Cozy</div>
                    <div class="slogan-subtitle">신선한 원두와 따뜻한 공간, 오늘도 함께</div>
                </div>

                <div class="login-bottom-section">

                    <!-- 1. 초기 로그인 화면 -->
                    <div id="login-options-group" class="btn-group fade-in">
                        <a href="/oauth2/authorization/kakao" class="login-btn btn-kakao-full">
                            <img src="https://developers.kakao.com/assets/img/about/logos/kakaotalksharing/kakaotalk_sharing_btn_medium.png"
                                 alt="Kakao" class="social-icon-inside-btn">
                            카카오 로그인
                        </a>

                        <button type="button" id="show-social-login-btn" class="login-btn btn-other-login">
                            다른 방법으로 로그인
                        </button>
                    </div>

                    <!-- 2. 소셜 로그인 선택 -->
                    <div id="social-login-group" class="btn-group hidden-group">
                        <a href="/oauth2/authorization/naver" class="login-btn btn-naver-full">
                            <img src="https://cdn.jsdelivr.net/npm/simple-icons@v13/icons/naver.svg"
                                 class="social-icon-inside-btn" style="filter: invert(1);">
                            네이버 로그인
                        </a>

                        <a href="/oauth2/authorization/google" class="login-btn btn-google-full">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg"
                                 class="social-icon-inside-btn">
                            Google 로그인
                        </a>

                        <button type="button" id="email-login-btn" class="login-btn btn-normal-full">
                            일반 로그인
                        </button>
                        <button type="button" id="back-to-login-btn" class="login-btn btn-cancel">취소</button>
                    </div>

                    <!-- 3. 일반 로그인 -->
                    <div id="email-login-form" class="btn-group hidden-group">
                        <div id="login-error-box"
                             th:if="${loginError}"
                             class="login-error-box"
                             style="display:block; color:#ff4d4f !important; font-weight:700; margin-bottom: 10px; font-size:14px; text-align:center;">
                            <span th:text="${loginError}"></span>
                        </div>
                        <form id="login-real-form" action="/login" method="post" class="signup-form-container">

                            <input type="text" name="username"
                                   placeholder="이메일" class="login-input" required>

                            <input type="password" name="password"
                                   placeholder="비밀번호" class="login-input" required>

                            <div class="remember-me-container">
                                <input type="checkbox" id="remember-me" name="remember-me">
                                <label for="remember-me">로그인 상태 유지</label>
                            </div>

                            <button type="submit" class="login-btn btn-normal-full">로그인</button>
                        </form>

                        <button type="button" id="back-to-login-options-btn" class="login-btn btn-cancel">
                            취소
                        </button>
                    </div>

                    <!-- 4. 회원가입 / 토글 -->
                    <div id="signup-initial-section" class="signup-or-login-toggle-section fade-in">
                        <div class="divider-with-text"><span class="text">또는</span></div>
                        <button type="button" id="show-signup-options-btn"
                                class="login-btn btn-other-login signup-toggle-btn">
                            회원가입
                        </button>
                    </div>

                    <!-- 5. 회원가입 방식 선택 -->
                    <div id="social-signup-group" class="btn-group hidden-group">
                        <a href="/oauth2/authorization/kakao" class="login-btn btn-kakao-full">
                            <img src="https://developers.kakao.com/assets/img/about/logos/kakaotalksharing/kakaotalk_sharing_btn_medium.png"
                                 class="social-icon-inside-btn">
                            카카오 회원가입
                        </a>
                        <a href="/oauth2/authorization/naver?mode=signup" class="login-btn btn-naver-full">
                            <img src="https://cdn.jsdelivr.net/npm/simple-icons@v13/icons/naver.svg"
                                 class="social-icon-inside-btn" style="filter: invert(1);">
                            네이버 회원가입
                        </a>
                        <a href="/oauth2/authorization/google?mode=signup" class="login-btn btn-google-full">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg"
                                 class="social-icon-inside-btn">
                            Google 회원가입
                        </a>

                        <button type="button" id="email-signup-btn" class="login-btn btn-normal-full">
                            일반 회원가입
                        </button>
                        <button type="button" id="back-to-main-btn" class="login-btn btn-cancel">취소</button>
                    </div>

                    <!-- 6. 일반 회원가입 입력 -->
                    <div id="email-signup-form" class="btn-group hidden-group">
                        <form id="signup-real-form" action="/api/member/signup" method="post"
                              class="signup-form-container">

                            <div class="input-group-row">
                                <input type="email" id="signup-email" name="email" placeholder="이메일" class="login-input" required>
                                <button type="button" id="check-email-btn" class="btn-check">중복확인</button>
                            </div>
                            <div id="email-check-msg" class="validation-msg"></div>

                            <input type="text" id="signup-username" name="username" placeholder="닉네임 (이름)" class="login-input" required>

                            <input type="password" id="signup-pw" name="password" placeholder="비밀번호" class="login-input" required>

                            <input type="password" id="signup-pw-confirm" name="passwordCheck" placeholder="비밀번호 확인" class="login-input" required>
                            <div id="pw-check-msg" class="validation-msg"></div>

                            <button type="submit" class="login-btn btn-normal-full" style="margin-top:10px;">
                                가입하기
                            </button>
                        </form>

                        <button type="button" id="back-to-signup-options-btn" class="login-btn btn-cancel">취소</button>
                    </div>
                </div>

            </div>

            <!-- 토스트 -->
            <div id="custom-toast" class="toast-hidden">
                <div class="toast-body">
                    <i class="fa-solid fa-check-circle toast-icon"></i>
                    <span id="toast-text">메시지 내용</span>
                </div>
            </div>
        </div>

        <!-- main.js -->
        <script src="/js/main.js"></script>

        <!-- 화면 전환/유효성만 남긴 스크립트 -->
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function () {

                const params = new URLSearchParams(window.location.search);
                const isSignupSuccess = params.get('signupSuccess') === 'true';

                if (isSignupSuccess) {
                    const username = params.get('username') || '회원';
                    // 토스트 띄우기
                    showToast(`회원가입 완료!\n${username}님 환영합니다. 로그인 해주세요.`);

                    // URL 파라미터 청소 (새로고침 시 반복 방지)
                    const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                    window.history.replaceState({path: cleanUrl}, '', cleanUrl);

                    // (선택) 화면을 로그인 폼으로 전환해두기
                    document.getElementById('login-options-group').style.display = 'none';
                    const emailLoginForm = document.getElementById('email-login-form');
                    emailLoginForm.style.display = 'flex';
                    emailLoginForm.classList.remove('hidden-group');
                    document.querySelector('.login-page-wrapper').classList.add('signup-mode');
                }

                /* 화면 요소 가져오기 */
                const loginPageWrapper = document.querySelector('.login-page-wrapper');
                const loginOptionsGroup = document.getElementById('login-options-group');
                const socialLoginGroup = document.getElementById('social-login-group');
                const emailLoginFormDiv = document.getElementById('email-login-form');
                const signupInitialSection = document.getElementById('signup-initial-section');
                const socialSignupGroup = document.getElementById('social-signup-group');
                const emailSignupFormDiv = document.getElementById('email-signup-form');

                /* 버튼 요소 가져오기 */
                const showSocialLoginBtn = document.getElementById('show-social-login-btn');
                const backToLoginBtn = document.getElementById('back-to-login-btn');
                const emailLoginBtn = document.getElementById('email-login-btn');
                const backToLoginOptionsBtn = document.getElementById('back-to-login-options-btn');
                const showSignupOptionsBtn = document.getElementById('show-signup-options-btn');
                const backToMainBtn = document.getElementById('back-to-main-btn');
                const emailSignupBtn = document.getElementById('email-signup-btn');
                const backToSignupOptionsBtn = document.getElementById('back-to-signup-options-btn');

                /* 회원가입 폼 요소 */
                const signupForm = document.getElementById('signup-real-form');
                const checkEmailBtn = document.getElementById('check-email-btn');
                const emailInput = document.getElementById('signup-email');
                const emailCheckMsg = document.getElementById('email-check-msg');
                const pwInput = document.getElementById('signup-pw');
                const pwConfirmInput = document.getElementById('signup-pw-confirm');
                const pwCheckMsg = document.getElementById('pw-check-msg');

                let isEmailChecked = false;

                /* 에러 발생 시 화면 처리 */
                const errorBox = document.getElementById('login-error-box');
                const hasError = errorBox != null;

                if (hasError) {
                    document.getElementById('login-options-group').style.display = 'none';
                    document.getElementById('signup-initial-section').style.display = 'none';
                    document.getElementById('social-login-group').style.display = 'none';

                    const emailLoginFormDiv = document.getElementById('email-login-form');
                    emailLoginFormDiv.style.display = 'flex';
                    emailLoginFormDiv.classList.remove('hidden-group');

                    const wrapper = document.querySelector('.login-page-wrapper');
                    wrapper.classList.add('signup-mode');
                }

                /* 그룹 전환 함수 (단일 교체용) */
                function switchGroup(hideElement, showElement) {
                    hideElement.classList.add('fade-out');
                    setTimeout(() => {
                        hideElement.style.display = 'none';
                        hideElement.classList.remove('fade-out'); // 숨긴 후 fade-out 제거

                        showElement.style.display = 'flex';
                        void showElement.offsetWidth; // 리플로우 강제
                        showElement.classList.remove('hidden-group');
                        showElement.classList.remove('fade-out'); // 혹시 남아있을지 모를 fade-out 제거
                        showElement.classList.add('fade-in');

                        setTimeout(() => showElement.classList.remove('fade-in'), 350);
                    }, 300);
                }

                /* 1. [초기화면] -> [다른 방법으로 로그인] */
                showSocialLoginBtn.addEventListener('click', () => {
                    loginOptionsGroup.classList.add('fade-out');
                    signupInitialSection.classList.add('fade-out');

                    setTimeout(() => {
                        loginOptionsGroup.style.display = 'none';
                        signupInitialSection.style.display = 'none';

                        socialLoginGroup.style.display = 'flex';
                        socialLoginGroup.classList.remove('hidden-group');
                        socialLoginGroup.classList.add('fade-in');

                        setTimeout(() => socialLoginGroup.classList.remove('fade-in'), 350);
                    }, 300);
                });

                /* 2. [다른 방법으로 로그인] -> [취소] (초기화면 복귀) ⭐[수정됨] */
                backToLoginBtn.addEventListener('click', () => {
                    // 현재 보고 있는 그룹 숨기기
                    socialLoginGroup.classList.add('fade-out');

                    setTimeout(() => {
                        socialLoginGroup.style.display = 'none';
                        socialLoginGroup.classList.remove('fade-out');

                        // 초기 옵션 그룹 복구
                        loginOptionsGroup.style.display = 'flex';
                        loginOptionsGroup.classList.remove('fade-out'); // ⭐ 중요: 투명화 해제
                        loginOptionsGroup.classList.add('fade-in');

                        // 하단 회원가입 섹션 복구
                        signupInitialSection.style.display = 'flex';
                        signupInitialSection.classList.remove('fade-out'); // ⭐ 중요: 투명화 및 클릭불가 해제
                        signupInitialSection.classList.add('fade-in');

                        setTimeout(() => {
                            loginOptionsGroup.classList.remove('fade-in');
                            signupInitialSection.classList.remove('fade-in');
                        }, 350);
                    }, 300);
                });

                /* 3. 일반 로그인 버튼 */
                emailLoginBtn.addEventListener('click', () => {
                    switchGroup(socialLoginGroup, emailLoginFormDiv);
                    loginPageWrapper.classList.add('signup-mode');
                });

                /* 4. 일반 로그인 -> 취소 */
                backToLoginOptionsBtn.addEventListener('click', () => {
                    switchGroup(emailLoginFormDiv, socialLoginGroup);
                    loginPageWrapper.classList.remove('signup-mode');
                    // 여기서 signupInitialSection은 안 보임 (socialLoginGroup 상태로 가므로)
                });

                /* 5. [초기화면] -> [회원가입] */
                showSignupOptionsBtn.addEventListener('click', () => {
                    // 초기 화면 요소들 숨기기
                    loginOptionsGroup.classList.add('fade-out');
                    signupInitialSection.classList.add('fade-out');

                    setTimeout(() => {
                        loginOptionsGroup.style.display = 'none';
                        signupInitialSection.style.display = 'none';

                        // 회원가입 선택 그룹 보이기
                        switchGroup(loginOptionsGroup, socialSignupGroup); // dummy call to reuse logic logic but we handle manually below actually
                        // switchGroup은 1:1 교환이라 직접 처리
                        socialSignupGroup.style.display = 'flex';
                        socialSignupGroup.classList.remove('hidden-group');
                        socialSignupGroup.classList.add('fade-in');

                        loginPageWrapper.classList.add('signup-selection-mode');
                        setTimeout(() => socialSignupGroup.classList.remove('fade-in'), 350);
                    }, 300);
                });

                /* 6. [회원가입 선택] -> [취소] (초기화면 복귀) ⭐[수정됨] */
                backToMainBtn.addEventListener('click', () => {
                    socialSignupGroup.classList.add('fade-out');

                    setTimeout(() => {
                        socialSignupGroup.style.display = 'none';
                        socialSignupGroup.classList.remove('fade-out');

                        // 초기 화면 복구
                        loginOptionsGroup.style.display = 'flex';
                        loginOptionsGroup.classList.remove('fade-out');
                        loginOptionsGroup.classList.add('fade-in');

                        signupInitialSection.style.display = 'flex';
                        signupInitialSection.classList.remove('fade-out'); // ⭐ 중요
                        signupInitialSection.classList.add('fade-in');

                        loginPageWrapper.classList.remove('signup-selection-mode');

                        setTimeout(() => {
                            loginOptionsGroup.classList.remove('fade-in');
                            signupInitialSection.classList.remove('fade-in');
                        }, 350);
                    }, 300);
                });

                emailSignupBtn.addEventListener('click', () => {
                    switchGroup(socialSignupGroup, emailSignupFormDiv);
                });

                backToSignupOptionsBtn.addEventListener('click', () => {
                    switchGroup(emailSignupFormDiv, socialSignupGroup);
                });

                /* ---------- 회원가입 유효성 검사 로직 (기존 유지) ---------- */
                function checkPasswordMatch() {
                    const pw = pwInput.value;
                    const confirmPw = pwConfirmInput.value;

                    if (!pw || !confirmPw) {
                        pwCheckMsg.textContent = "";
                        return;
                    }

                    if (pw === confirmPw) {
                        pwCheckMsg.textContent = "비밀번호가 서로 일치합니다.";
                        pwCheckMsg.className = "validation-msg text-success";
                    } else {
                        pwCheckMsg.textContent = "비밀번호가 서로 일치하지 않습니다.";
                        pwCheckMsg.className = "validation-msg text-danger";
                    }
                }

                pwInput.addEventListener('input', checkPasswordMatch);
                pwConfirmInput.addEventListener('input', checkPasswordMatch);

                checkEmailBtn.addEventListener('click', function () {
                    const email = emailInput.value.trim();
                    if (!email) {
                        showToast("이메일을 입력해주세요.", "error");
                        return;
                    }

                    fetch('/api/member/check-email?email=' + encodeURIComponent(email))
                        .then(response => {
                            if (response.ok) return response.json();
                            else throw new Error();
                        })
                        .then(data => {
                            emailCheckMsg.textContent = "사용 가능한 이메일입니다.";
                            emailCheckMsg.className = "validation-msg text-success show";
                            isEmailChecked = true;
                        })
                        .catch(() => {
                            emailCheckMsg.textContent = "이미 존재하는 이메일입니다.";
                            emailCheckMsg.className = "validation-msg text-danger show";
                            isEmailChecked = false;
                        });
                });

                emailInput.addEventListener('input', () => {
                    isEmailChecked = false;
                    emailCheckMsg.textContent = "";
                    emailCheckMsg.className = "";
                });

                signupForm.addEventListener('submit', function (e) {
                    if (!isEmailChecked) {
                        e.preventDefault();
                        showToast("이메일 중복 확인을 해주세요.", "error");
                        return;
                    }
                    const pw = pwInput.value;
                    const confirmPw = pwConfirmInput.value;
                    if (pw !== confirmPw) {
                        e.preventDefault();
                        showToast("비밀번호가 일치하지 않습니다.", "error");
                    }
                });
            });
        </script>
    </div>
</th:block>
</html>
