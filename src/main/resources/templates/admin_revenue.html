<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>관리자 매출관리 - Java Cafe</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/admin_revenue.css">
</head>

<body>

<th:block th:replace="~{./include/adminBaseLayout :: setContent( ~{:: .wrap} ) }">
    <div class="wrap">
        <div class="container">
            <div class="controls">
                <label for="criterion">조회기준:</label>
                <select id="criterion" onchange="onCriterionChange()">
                    <option value="day" selected>일</option>
                    <option value="month">월</option>
                    <option value="quarter">분기</option>
                </select>

                <!-- 지점 선택 -->
                <select id="storeSelect" style="margin-left:10px;">
                    <option value="">전체 지점</option>
                    <th:block th:each="store : ${storeList}">
                        <option th:value="${store}" th:text="${store}"></option>
                    </th:block>
                </select>

                <!-- 일 단위 -->
                <input type="date" id="date"
                       th:value="${selectedDate}"
                       min="2023-01-01" max="${selectedDate}"
                       style="margin-left:10px;">

                <!-- 월 단위 -->
                <div id="monthControls" style="display:none; margin-left:10px;">
                    <select id="monthYear"></select>
                    <select id="monthSelect"></select>
                </div>

                <!-- 분기 단위 -->
                <div id="quarterControls" style="display:none; margin-left:10px;">
                    <select id="quarterYear"></select>
                    <select id="quarterSelect">
                        <option value="Q1">12~02 (겨울)</option>
                        <option value="Q2">03~05 (봄)</option>
                        <option value="Q3">06~08 (여름)</option>
                        <option value="Q4">09~11 (가을)</option>
                    </select>
                </div>

                <button onclick="loadData()">조회하기</button>
            </div>

            <div class="total-revenue" id="totalRevenue">총 매출 금액: 0원</div>
            <table>
                <thead>
                <tr>
                    <th>주문 시간</th>
                    <th>주문 번호</th>
                    <th>주문 금액</th>
                    <th>결제 방식</th>
                </tr>
                </thead>

                <tbody id="orderTableBody"></tbody>
            </table>
        </div>
    </div>
</th:block>

<script>
    window.addEventListener("DOMContentLoaded", function() {
        initYearMonthQuarterControls();

        const dateInput = document.getElementById("date");
        const today = new Date().toISOString().slice(0,10);
        if(!dateInput.value) dateInput.value = today;

        dateInput.addEventListener("input", function() {
            const parts = this.value.split("-");
            if(parts[0].length > 4) parts[0] = parts[0].slice(0, 4);
            if(parts[1].length > 2) parts[1] = parts[1].slice(0, 2);
            if(parts[2].length > 2) parts[2] = parts[2].slice(0, 2);
            this.value = parts.join("-");
        });

        loadData();
    });

    function initYearMonthQuarterControls() {
        const now = new Date();
        const year = now.getFullYear();
        const startYear = year - 3;
        const endYear = year + 1;

        const monthYear = document.getElementById("monthYear");
        const monthSelect = document.getElementById("monthSelect");
        const quarterYear = document.getElementById("quarterYear");

        for(let y = startYear; y <= endYear; y++) {
            monthYear.innerHTML += `<option value="${y}">${y}년</option>`;
            quarterYear.innerHTML += `<option value="${y}">${y}년</option>`;
        }

        monthYear.value = year;
        quarterYear.value = year;

        for(let m=1; m<=12; m++) {
            monthSelect.innerHTML += `<option value="${m}">${m}월</option>`;
        }
        monthSelect.value = (now.getMonth() + 1);

        onCriterionChange();
    }

    function onCriterionChange() {
        const c = document.getElementById("criterion").value;
        document.getElementById("date").style.display = (c === "day") ? "inline-block" : "none";
        document.getElementById("monthControls").style.display = (c === "month") ? "inline-block" : "none";
        document.getElementById("quarterControls").style.display = (c === "quarter") ? "inline-block" : "none";
    }

    function loadData() {
        const criterion = document.getElementById("criterion").value;
        const store = document.getElementById("storeSelect").value;

        let startDate = null;
        let endDate = null;

        if(criterion === "day") {
            const date = document.getElementById("date").value;
            startDate = endDate = date;
        }
        else if(criterion === "month") {
            const y = Number(document.getElementById("monthYear").value);
            const m = Number(document.getElementById("monthSelect").value);
            startDate = `${y}-${String(m).padStart(2,'0')}-01`;
            const last = new Date(y, m, 0).getDate();
            endDate = `${y}-${String(m).padStart(2,'0')}-${String(last).padStart(2,'0')}`;
        }
        else if(criterion === "quarter") {
            const y = Number(document.getElementById("quarterYear").value);
            const q = document.getElementById("quarterSelect").value;

            if(q === "Q1") {
                const startY = y - 1;
                startDate = `${startY}-12-01`;
                const last = new Date(y, 2, 0).getDate();
                endDate = `${y}-02-${String(last).padStart(2,'0')}`;
            }
            else if(q === "Q2") {
                startDate = `${y}-03-01`;
                const last = new Date(y, 5, 0).getDate();
                endDate = `${y}-05-${String(last).padStart(2,'0')}`;
            }
            else if(q === "Q3") {
                startDate = `${y}-06-01`;
                const last = new Date(y, 8, 0).getDate();
                endDate = `${y}-08-${String(last).padStart(2,'0')}`;
            }
            else if(q === "Q4") {
                startDate = `${y}-09-01`;
                const last = new Date(y, 11, 0).getDate();
                endDate = `${y}-11-${String(last).padStart(2,'0')}`;
            }
        }

        const url =
            `/admin/revenue/orders?startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}&store=${encodeURIComponent(store)}`;

        fetch(url)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById("orderTableBody");
                tbody.innerHTML = "";
                let total = 0;

                data.forEach(order => {
                    total += Number(order.orderAmount);

                    tbody.innerHTML += `
                        <tr>
                            <td>${order.orderTime}</td>
                            <td>${order.orderId}</td>
                            <td>${Number(order.orderAmount).toLocaleString()}원</td>
                            <td>${order.orderType}</td>
                        </tr>`;
                });

                document.getElementById("totalRevenue").innerText =
                    "총 매출 금액: " + total.toLocaleString() + "원";
            })
            .catch(err => {
                console.error(err);
                alert("데이터를 불러오는 중 오류가 발생했습니다.");
            });
    }
</script>

</body>
</html>
